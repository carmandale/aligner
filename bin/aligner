#!/usr/bin/env bash
#
# Aligner CLI - Visual feedback loop for AI agents
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SERVER_PORT="${PORT:-3001}"
VIEWER_PORT="${ALIGNER_VIEWER_PORT:-5173}"
VIEWER_HOST="127.0.0.1"
VIEWER_URL="http://${VIEWER_HOST}:${VIEWER_PORT}"
DEFAULT_API_URL="http://${VIEWER_HOST}:${SERVER_PORT}"
DEFAULT_WS_URL="ws://${VIEWER_HOST}:${SERVER_PORT}"

usage() {
  cat <<EOF2
⚡ Aligner - Visual feedback loop for AI agents

Usage: aligner <command>

Commands:
  init        Initialize current directory as an Aligner repo
  register    Add current directory to registry (requires .aligner/)
  unregister  Remove current directory from registry
  repos       List all registered repositories
  start       Start Aligner server and viewer
  server      Start only the API server
  viewer      Start only the web viewer
  list        List all diagrams
  open        Open Aligner in browser
  help        Show this help

Environment:
  ALIGNER_DIR           Diagram directory (default: ~/.aligner)
  PORT                  Server port (default: 3001)
  ALIGNER_VIEWER_PORT   Viewer port (default: 5173)
  VITE_ALIGNER_API_URL  Frontend API base (default: http://127.0.0.1:3001)
  VITE_ALIGNER_WS_URL   Frontend WebSocket URL (default: ws://127.0.0.1:3001)

Examples:
  aligner init                      # Initialize current directory
  aligner init --name "My Project"  # With custom name
  aligner register                  # Add to registry
  aligner repos                     # List all repos
  aligner start                     # Start everything
  aligner list                      # Show available diagrams
  aligner open                      # Open in browser

EOF2
}

ensure_global_command() {
  if command -v aligner >/dev/null 2>&1; then
    return
  fi

  local script_path="$SCRIPT_DIR/aligner"
  local target_dir=""
  local candidate

  for candidate in "$HOME/.local/bin" "$HOME/bin" "/opt/homebrew/bin" "/usr/local/bin"; do
    if [[ ":$PATH:" == *":$candidate:"* ]] && [ -d "$candidate" ] && [ -w "$candidate" ]; then
      target_dir="$candidate"
      break
    fi
  done

  if [ -z "$target_dir" ]; then
    IFS=':' read -r -a path_dirs <<< "$PATH"
    for candidate in "${path_dirs[@]}"; do
      if [ -d "$candidate" ] && [ -w "$candidate" ]; then
        target_dir="$candidate"
        break
      fi
    done
  fi

  if [ -z "$target_dir" ]; then
    return
  fi

  if [ ! -e "$target_dir/aligner" ]; then
    ln -s "$script_path" "$target_dir/aligner" 2>/dev/null || true
  fi
}

start_server() {
  echo -e "${BLUE}Starting Aligner server...${NC}"
  cd "$ROOT_DIR/server"
  PORT="$SERVER_PORT" node index.js &
  SERVER_PID=$!
  echo $SERVER_PID > /tmp/aligner-server.pid
}

start_viewer() {
  echo -e "${BLUE}Starting Aligner viewer...${NC}"
  cd "$ROOT_DIR"
  : "${VITE_ALIGNER_API_URL:=$DEFAULT_API_URL}"
  : "${VITE_ALIGNER_WS_URL:=$DEFAULT_WS_URL}"
  export VITE_ALIGNER_API_URL VITE_ALIGNER_WS_URL
  npm run dev -- --host "$VIEWER_HOST" --port "$VIEWER_PORT" --strictPort &
  VIEWER_PID=$!
  echo $VIEWER_PID > /tmp/aligner-viewer.pid
}

stop_all() {
  echo -e "${YELLOW}Stopping Aligner...${NC}"
  [ -f /tmp/aligner-server.pid ] && kill $(cat /tmp/aligner-server.pid) 2>/dev/null || true
  [ -f /tmp/aligner-viewer.pid ] && kill $(cat /tmp/aligner-viewer.pid) 2>/dev/null || true
  rm -f /tmp/aligner-server.pid /tmp/aligner-viewer.pid
}

list_diagrams() {
  # Delegate to Node.js module for consistency with other commands
  node "$SCRIPT_DIR/aligner-list.js" "$@"
}

open_browser() {
  sleep 2
  if command -v open &>/dev/null; then
    open "$VIEWER_URL"
  elif command -v xdg-open &>/dev/null; then
    xdg-open "$VIEWER_URL"
  fi
}

ensure_global_command

case "${1:-}" in
  init)
    shift  # Remove 'init' from args
    exec node "$SCRIPT_DIR/aligner-init.js" "$@"
    ;;
  register)
    shift  # Remove 'register' from args
    exec node "$SCRIPT_DIR/aligner-register.js" "$@"
    ;;
  unregister)
    shift  # Remove 'unregister' from args
    exec node "$SCRIPT_DIR/aligner-unregister.js" "$@"
    ;;
  repos)
    shift  # Remove 'repos' from args
    exec node "$SCRIPT_DIR/aligner-repos.js" "$@"
    ;;
  start)
    trap stop_all EXIT
    start_server
    sleep 1
    start_viewer
    open_browser
    echo -e "${GREEN}✓ Aligner running${NC}"
    echo -e "  Server: $DEFAULT_API_URL"
    echo -e "  Viewer: $VIEWER_URL"
    echo ""
    echo "Press Ctrl+C to stop"
    wait
    ;;
  server)
    cd "$ROOT_DIR/server"
    PORT="$SERVER_PORT" exec node index.js
    ;;
  viewer)
    cd "$ROOT_DIR"
    : "${VITE_ALIGNER_API_URL:=$DEFAULT_API_URL}"
    : "${VITE_ALIGNER_WS_URL:=$DEFAULT_WS_URL}"
    export VITE_ALIGNER_API_URL VITE_ALIGNER_WS_URL
    exec npm run dev -- --host "$VIEWER_HOST" --port "$VIEWER_PORT" --strictPort
    ;;
  list)
    list_diagrams
    ;;
  open)
    open_browser
    ;;
  help|--help|-h|"")
    usage
    ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    usage
    exit 1
    ;;
esac
