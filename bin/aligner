#!/usr/bin/env bash
#
# Aligner CLI - Visual feedback loop for AI agents
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
  cat <<EOF
⚡ Aligner - Visual feedback loop for AI agents

Usage: aligner <command>

Commands:
  init        Initialize current directory as an Aligner repo
  register    Add current directory to registry (requires .aligner/)
  unregister  Remove current directory from registry
  repos       List all registered repositories
  start       Start Aligner server and viewer
  server      Start only the API server
  viewer      Start only the web viewer
  list        List all diagrams
  open        Open Aligner in browser
  help        Show this help

Environment:
  ALIGNER_DIR    Diagram directory (default: ~/.aligner)
  PORT           Server port (default: 3001)

Examples:
  aligner init                      # Initialize current directory
  aligner init --name "My Project"  # With custom name
  aligner register                  # Add to registry
  aligner repos                     # List all repos
  aligner start                     # Start everything
  aligner list                      # Show available diagrams
  aligner open                      # Open in browser

EOF
}

start_server() {
  echo -e "${BLUE}Starting Aligner server...${NC}"
  cd "$ROOT_DIR/server"
  node index.js &
  SERVER_PID=$!
  echo $SERVER_PID > /tmp/aligner-server.pid
}

start_viewer() {
  echo -e "${BLUE}Starting Aligner viewer...${NC}"
  cd "$ROOT_DIR"
  npm run dev &
  VIEWER_PID=$!
  echo $VIEWER_PID > /tmp/aligner-viewer.pid
}

stop_all() {
  echo -e "${YELLOW}Stopping Aligner...${NC}"
  [ -f /tmp/aligner-server.pid ] && kill $(cat /tmp/aligner-server.pid) 2>/dev/null || true
  [ -f /tmp/aligner-viewer.pid ] && kill $(cat /tmp/aligner-viewer.pid) 2>/dev/null || true
  rm -f /tmp/aligner-server.pid /tmp/aligner-viewer.pid
}

list_diagrams() {
  # Delegate to Node.js module for consistency with other commands
  node "$SCRIPT_DIR/aligner-list.js" "$@"
}

open_browser() {
  sleep 2
  if command -v open &>/dev/null; then
    open "http://localhost:5173"
  elif command -v xdg-open &>/dev/null; then
    xdg-open "http://localhost:5173"
  fi
}

case "${1:-}" in
  init)
    shift  # Remove 'init' from args
    exec node "$SCRIPT_DIR/aligner-init.js" "$@"
    ;;
  register)
    shift  # Remove 'register' from args
    exec node "$SCRIPT_DIR/aligner-register.js" "$@"
    ;;
  unregister)
    shift  # Remove 'unregister' from args
    exec node "$SCRIPT_DIR/aligner-unregister.js" "$@"
    ;;
  repos)
    shift  # Remove 'repos' from args
    exec node "$SCRIPT_DIR/aligner-repos.js" "$@"
    ;;
  start)
    trap stop_all EXIT
    start_server
    sleep 1
    start_viewer
    open_browser
    echo -e "${GREEN}✓ Aligner running${NC}"
    echo -e "  Server: http://localhost:3001"
    echo -e "  Viewer: http://localhost:5173"
    echo ""
    echo "Press Ctrl+C to stop"
    wait
    ;;
  server)
    cd "$ROOT_DIR/server"
    exec node index.js
    ;;
  viewer)
    cd "$ROOT_DIR"
    exec npm run dev
    ;;
  list)
    list_diagrams
    ;;
  open)
    open_browser
    ;;
  help|--help|-h|"")
    usage
    ;;
  *)
    echo -e "${RED}Unknown command: $1${NC}"
    usage
    exit 1
    ;;
esac
